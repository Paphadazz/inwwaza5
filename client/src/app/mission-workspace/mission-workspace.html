<div class="workspace-container" *ngIf="mission() as m">
    <div class="workspace-header">
        <div class="header-left">
            <button mat-icon-button routerLink="/missions" aria-label="Back to missions">
                <mat-icon>arrow_back</mat-icon>
            </button>
            <h1>{{m.name}}</h1>
        </div>

        <div class="header-actions">
            <button mat-stroked-button color="primary" (click)="navigateToDashboard()">
                <mat-icon>dashboard</mat-icon>
                View Mission Summary
            </button>
            <button mat-stroked-button color="accent" (click)="goToEvidence()" *ngIf="isUserChief()">
                <mat-icon>folder_shared</mat-icon>
                Evidence Repository
            </button>
            <input type="file" id="fileInput" style="display: none" (change)="onFileSelected($event)"
                accept=".png,.jpeg,.jpg,.doc,.docx,.pdf">
            <button mat-stroked-button color="warn" (click)="leave()" *ngIf="!isUserChief()">
                <mat-icon ripple>logout</mat-icon>
                Leave Mission
            </button>
        </div>
    </div>

    <div class="workspace-content">
        <!-- Main Column -->
        <div class="main-content">
            <!-- Mission details section -->
            <mat-card class="details-card">
                <mat-card-header>
                    <mat-card-title>Mission Directive</mat-card-title>
                    <mat-card-subtitle>Commanded by: {{m.chief_display_name}}</mat-card-subtitle>
                </mat-card-header>
                <mat-card-content>
                    <p class="description">{{m.description || 'No specialized instructions provided.'}}</p>

                    <div class="meta-info">
                        <div class="meta-item">
                            <mat-icon>info</mat-icon>
                            <span><strong>Status:</strong> {{m.status | uppercase}}</span>
                        </div>
                        <div class="meta-item">
                            <mat-icon>calendar_today</mat-icon>
                            <span><strong>Initiated:</strong> {{m.created_at | date:'medium'}}</span>
                        </div>
                        <div class="meta-item">
                            <mat-icon>group</mat-icon>
                            <span><strong>Force:</strong> {{memberCount()}} / {{m.max_members}} Operatives</span>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <!-- Tasks Section -->
            <mat-card class="tasks-card">
                <mat-card-header>
                    <div class="tasks-header">
                        <mat-card-title>Mission Tasks</mat-card-title>
                        <button mat-flat-button color="primary" (click)="createTask()" *ngIf="isUserChief()">
                            <mat-icon>add</mat-icon>
                            New Task
                        </button>
                    </div>
                </mat-card-header>
                <mat-card-content>
                    <div class="empty-state" *ngIf="tasks().length === 0">
                        <mat-icon>assignment</mat-icon>
                        <p>No active tasks yet.</p>
                    </div>

                    <mat-list>
                        <mat-list-item *ngFor="let task of tasks()" class="task-item">
                            <mat-icon matListItemIcon
                                [class]="'priority-' + (task.priority || 'Medium').toLowerCase()">assignment</mat-icon>
                            <div matListItemTitle class="task-title">
                                {{task.title}}
                                <span class="status-badge" [class]="task.status.toLowerCase()">{{task.status}}</span>
                            </div>
                            <div matListItemLine class="task-meta">
                                <span>Priority: {{task.priority || 'Medium'}}</span>
                                <span *ngIf="task.member_id"> â€¢ Assigned to: {{task.member_id}}</span>
                            </div>
                            <div matListItemMeta>
                                <!-- Member Action: Submit Work for specific task -->
                                <ng-container *ngIf="!isUserChief() && task.member_id === currentUserId()">
                                    <button mat-icon-button color="primary" *ngIf="!task.has_submission"
                                        (click)="triggerFileInput(task.id)" matTooltip="Submit Work for this Task">
                                        <mat-icon>upload_file</mat-icon>
                                    </button>

                                    <!-- Member can view their own submission -->
                                    <button mat-icon-button color="primary" (click)="viewSubmission(task.id)"
                                        *ngIf="task.has_submission" matTooltip="View My Submission">
                                        <mat-icon>visibility</mat-icon>
                                    </button>

                                    <!-- Member can delete/retract their own submission -->
                                    <button mat-icon-button color="warn" (click)="deleteSubmission(task.id)"
                                        *ngIf="task.has_submission && task.status !== 'Success'"
                                        matTooltip="Retract and Resubmit">
                                        <mat-icon>delete_sweep</mat-icon>
                                    </button>
                                </ng-container>

                                <!-- Chief Actions -->
                                <ng-container *ngIf="isUserChief()">
                                    <!-- View Submission if available -->
                                    <button mat-icon-button color="primary" (click)="viewSubmission(task.id)"
                                        *ngIf="task.has_submission" matTooltip="View Submission">
                                        <mat-icon>visibility</mat-icon>
                                    </button>

                                    <!-- Update Status -->
                                    <button mat-icon-button [matMenuTriggerFor]="statusMenu" matTooltip="Update Status">
                                        <mat-icon>edit_note</mat-icon>
                                    </button>
                                    <mat-menu #statusMenu="matMenu">
                                        <button mat-menu-item
                                            (click)="updateTaskStatus(task.id, 'Pending')">Pending</button>
                                        <button mat-menu-item (click)="updateTaskStatus(task.id, 'In Progress')">In
                                            Progress</button>
                                        <button mat-menu-item
                                            (click)="updateTaskStatus(task.id, 'Review')">Review</button>
                                        <button mat-menu-item
                                            (click)="updateTaskStatus(task.id, 'Success')">Success</button>
                                        <button mat-menu-item
                                            (click)="updateTaskStatus(task.id, 'Failed')">Failed</button>
                                    </mat-menu>

                                    <button mat-icon-button color="warn" (click)="deleteTask(task.id)">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </ng-container>
                            </div>
                        </mat-list-item>
                    </mat-list>
                </mat-card-content>
            </mat-card>
        </div>

        <!-- Sidebar Column -->
        <div class="sidebar-content">
            <!-- Members section -->
            <mat-card class="members-sidebar">
                <mat-card-header>
                    <div class="members-header">
                        <mat-card-title>Squad Roster</mat-card-title>
                        <div class="header-right">
                            <div class="count-badge">
                                {{memberCount()}} / {{m.max_members}}
                            </div>
                            <button mat-icon-button class="settings-btn" *ngIf="isUserChief()"
                                (click)="openSquadSettings()" matTooltip="Squad Configuration">
                                <mat-icon>settings</mat-icon>
                            </button>
                        </div>
                    </div>
                </mat-card-header>
                <mat-list>
                    <div mat-subheader>Active Personnel</div>
                    <mat-list-item *ngFor="let member of members()">
                        <img matListItemAvatar [src]="member.avatar_url || 'assets/default-avatar.png'" alt="Avatar">

                        <div matListItemTitle>
                            <div class="member-content">
                                <div class="member-header">
                                    <span class="member-name">{{member.display_name}}</span>
                                    <span *ngIf="isCurrentUser(member)" class="you-badge">
                                        <mat-icon>star</mat-icon>
                                        You
                                    </span>
                                </div>

                                <div class="member-badges">
                                    <mat-chip-set>
                                        <mat-chip *ngIf="isChief(member)" class="chief-chip"
                                            highlighted>Chief</mat-chip>
                                    </mat-chip-set>

                                    <div *ngIf="!isUserChief() || isChief(member)" class="role-display">
                                        {{member.role}}
                                    </div>

                                    <button class="role-select-btn" mat-button [matMenuTriggerFor]="roleMenu"
                                        *ngIf="isUserChief() && !isChief(member)">
                                        {{member.role}}
                                        <mat-icon iconPositionEnd
                                            style="font-size: 16px; width: 16px; height: 16px; vertical-align: middle;">arrow_drop_down</mat-icon>
                                    </button>
                                    <mat-menu #roleMenu="matMenu">
                                        <button mat-menu-item *ngFor="let role of availableRoles"
                                            (click)="updateRole(member.id, role)">
                                            {{role}}
                                        </button>
                                    </mat-menu>

                                    <button mat-icon-button color="primary" *ngIf="isUserChief() && !isChief(member)"
                                        (click)="viewMemberEvidence(member)" matTooltip="View Evidence">
                                        <mat-icon>folder_shared</mat-icon>
                                    </button>

                                    <button mat-icon-button color="warn" *ngIf="isUserChief() && !isChief(member)"
                                        (click)="kickMember(member.id)" matTooltip="Remove Member">
                                        <mat-icon>person_remove</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </mat-list-item>
                </mat-list>
            </mat-card>
        </div>
    </div>
</div>

<div class="loading-overlay" *ngIf="!mission()">
    <mat-spinner diameter="50" color="accent"></mat-spinner>
    <p>Synchronizing Workspace...</p>
</div>